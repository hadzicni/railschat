<%
  # Determine if this is the current user's message
  is_own_message = false
  begin
    if local_assigns[:current_user_id]
      is_own_message = message.user.id == local_assigns[:current_user_id]
    elsif respond_to?(:current_user) && current_user
      is_own_message = message.user.id == current_user.id
    end
  rescue
    # Ignore Devise errors in WebSocket context
  end
%>

<div class="message-wrapper mb-3 <%= 'own-message' if is_own_message %>" id="message-<%= message.id %>" data-message-id="<%= message.id %>">
  <!-- Reply indicator if this is a reply -->
  <% if message.reply? %>
    <div class="reply-indicator mb-2 <%= is_own_message ? 'text-end' : 'text-start' %>">
      <div class="reply-preview d-inline-block p-2 bg-light rounded-2 border-start border-primary border-3" style="max-width: 70%;">
        <div class="d-flex align-items-center gap-2 mb-1">
          <i class="bi bi-reply text-primary"></i>
          <small class="text-muted">
            <%= t('chat.reply_to') %>
            <% unless is_own_message && message.reply_to.user.id == current_user.id %>
              <%= message.reply_to.user.display_name %>
            <% else %>
              <%= t('status.you') %>
            <% end %>
          </small>
        </div>
        <div class="reply-content text-muted small">
          <%= truncate(message.reply_to.content, length: 100) %>
        </div>
      </div>
    </div>
  <% end %>

  <div class="message-bubble-container <%= is_own_message ? 'justify-content-end' : 'justify-content-start' %> d-flex">
    <% unless is_own_message %>
      <div class="profile-avatar me-2" style="width: 35px; height: 35px; font-size: 1rem;">
        <%= message.user.initials %>
      </div>
    <% end %>

    <div class="message-bubble <%= is_own_message ? 'own-bubble' : 'other-bubble' %>" style="max-width: 70%;">
      <% unless is_own_message %>
        <div class="message-header mb-1">
          <%= link_to user_path(message.user), class: "text-decoration-none" do %>
            <span class="username fw-bold">
              <%= message.user.display_name %>
            </span>
          <% end %>
          <%= role_badge(message.user) %>
        </div>
      <% end %>

      <div class="message-content mb-1">
        <%= simple_format(message.content, {}, wrapper_tag: "div") %>
      </div>

      <div class="message-footer d-flex <%= is_own_message ? 'justify-content-between' : 'justify-content-end' %> align-items-center">
        <% if is_own_message %>
          <button class="btn btn-sm reply-btn"
                  data-message-id="<%= message.id %>"
                  data-user-name="<%= message.user.display_name %>"
                  data-content="<%= message.content %>"
                  title="<%= t('chat.reply') %>">
            <i class="bi bi-reply" style="color: rgba(255,255,255,0.7);"></i>
          </button>
        <% else %>
          <button class="btn btn-sm reply-btn me-2"
                  data-message-id="<%= message.id %>"
                  data-user-name="<%= message.user.display_name %>"
                  data-content="<%= message.content %>"
                  title="<%= t('chat.reply') %>">
            <i class="bi bi-reply text-muted"></i>
          </button>
        <% end %>

        <small class="timestamp <%= is_own_message ? 'text-light' : 'text-muted' %>">
          <i class="bi bi-clock me-1"></i>
          <%= format_datetime(message.created_at, :short_time) %>
        </small>
      </div>
    </div>

    <% if is_own_message %>
      <div class="profile-avatar ms-2" style="width: 35px; height: 35px; font-size: 1rem;">
        <%= message.user.initials %>
      </div>
    <% end %>
  </div>
</div>
