<div class="message-item mb-3 p-3" id="message-<%= message.id %>" data-message-id="<%= message.id %>">
  <!-- Reply indicator if this is a reply -->
  <% if message.reply? %>
    <div class="reply-indicator mb-2">
      <div class="reply-preview p-2 bg-light rounded-2 border-start border-primary border-3">
        <div class="d-flex align-items-center gap-2 mb-1">
          <i class="bi bi-reply text-primary"></i>
          <small class="text-muted">Antwort auf <%= message.reply_to.user.display_name %></small>
        </div>
        <div class="reply-content text-muted small">
          <%= truncate(message.reply_to.content, length: 100) %>
        </div>
      </div>
    </div>
  <% end %>

  <div class="d-flex align-items-start">
    <div class="profile-avatar me-3" style="width: 45px; height: 45px; font-size: 1.3rem;">
      <%= message.user.initials %>
    </div>
    <div class="flex-grow-1">
      <div class="d-flex justify-content-between align-items-center mb-1">
        <div class="d-flex align-items-center gap-2">
          <%= link_to user_path(message.user), class: "text-decoration-none" do %>
            <h6 class="mb-0 text-primary fw-bold">
              <%= message.user.display_name %>
            </h6>
          <% end %>
          <%
            user_id = nil
            begin
              if local_assigns[:current_user_id]
                user_id = local_assigns[:current_user_id]
              elsif respond_to?(:current_user) && current_user
                user_id = current_user.id
              end
            rescue
              # Ignore Devise errors in WebSocket context
            end
          %>
          <% if user_id && message.user.id == user_id %>
            <span class="badge bg-primary bg-opacity-10 text-primary">Du</span>
          <% end %>
        </div>
        <div class="d-flex align-items-center gap-2">
          <small class="text-muted d-flex align-items-center">
            <i class="bi bi-clock me-1"></i>
            <%= message.created_at.strftime('%H:%M') %>
          </small>
          <!-- Reply button -->
          <button class="btn btn-sm btn-outline-secondary reply-btn"
                  data-message-id="<%= message.id %>"
                  data-user-name="<%= message.user.display_name %>"
                  data-content="<%= message.content %>"
                  title="Antworten">
            <i class="bi bi-reply"></i>
          </button>
        </div>
      </div>
      <div class="message-content">
        <%= simple_format(message.content, {}, wrapper_tag: "div") %>
      </div>
    </div>
  </div>
</div>
