<div class="container">
  <div class="row">
    <div class="col-12">
      <!-- Room Header -->
      <div class="card mb-3">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h3 class="mb-1">
                <i class="bi bi-chat-square-text me-2"></i>
                <%= @room.name %>
              </h3>
              <p class="text-muted mb-0">
                <i class="bi bi-people me-1"></i>
                <%= @room.messages.select(:user_id).distinct.count %> Teilnehmer
              </p>
            </div>
            <div>
              <%= link_to rooms_path, class: "btn btn-outline-secondary" do %>
                <i class="bi bi-arrow-left me-1"></i>
                Zur√ºck
              <% end %>
            </div>
          </div>

          <% if @room.description.present? %>
            <div class="mt-3 p-2 bg-light rounded small">
              <%= @room.description %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Chat Area -->
    <div class="col-lg-8">
      <div class="card" style="height: 60vh; min-height: 400px;">
        <div class="card-header">
          <h6 class="mb-0">
            <i class="bi bi-chat-dots me-2"></i>
            Chat
          </h5>
        </div>

        <div class="card-body p-0 d-flex flex-column" style="height: calc(100% - 60px);">
          <!-- Messages Container -->
          <div class="flex-grow-1 chat-container p-3 overflow-auto" id="messages-container" style="height: calc(100% - 80px);">
            <% if @messages.any? %>
              <% @messages.each do |message| %>
                <%= render 'messages/message', message: message %>
              <% end %>
            <% else %>
              <div class="text-center text-muted py-5" id="no-messages">
                <i class="bi bi-chat-square-dots fs-1 mb-3 d-block"></i>
                <h5>Noch keine Nachrichten in diesem Chatraum</h5>
                <p>Sei der Erste und starte die Unterhaltung!</p>
              </div>
            <% end %>
          </div>

          <!-- Message Input -->
          <div class="border-top p-3" style="min-height: 80px;">
            <!-- Reply Preview -->
            <div id="reply-preview" class="reply-preview-container mb-2" style="display: none;">
              <div class="d-flex align-items-center justify-content-between p-2 bg-light rounded-2 border-start border-primary border-3">
                <div class="flex-grow-1">
                  <div class="d-flex align-items-center gap-2 mb-1">
                    <i class="bi bi-reply text-primary"></i>
                    <small class="text-muted">Antwort auf <span id="reply-user-name"></span></small>
                  </div>
                  <div class="reply-content text-muted small" id="reply-content-preview"></div>
                </div>
                <button type="button" class="btn btn-sm btn-outline-secondary" id="cancel-reply">
                  <i class="bi bi-x"></i>
                </button>
              </div>
            </div>

            <%= form_with model: [@room, @message],
                local: false,
                id: "message-form",
                class: "d-flex gap-2" do |form| %>
              <%= form.hidden_field :reply_to_id, id: "reply-to-id" %>
              <div class="flex-grow-1">
                <%= form.text_area :content,
                    placeholder: "Schreibe eine Nachricht...",
                    class: "form-control border-0",
                    rows: 1,
                    id: "message-input",
                    required: true,
                    style: "resize: none; box-shadow: none; max-height: 60px;" %>
              </div>
              <div class="align-self-end">
                <%= form.submit class: "btn btn-primary px-3 py-2", id: "send-button" do %>
                  <i class="bi bi-send-fill"></i>
                <% end %>
              </div>
            <% end %>

            <div id="message-errors" class="alert alert-danger mt-2 mb-0" style="display: none;"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
      <!-- Online Users -->
      <div class="card mb-4">
        <div class="card-header">
          <h6 class="mb-0">
            <i class="bi bi-people me-2"></i>
            Aktive Teilnehmer
          </h6>
        </div>
        <div class="card-body">
          <% active_users = @room.messages.includes(:user).select(:user_id).distinct.map(&:user).uniq %>
          <% if active_users.any? %>
            <% active_users.each do |user| %>
              <div class="d-flex align-items-center mb-3">
                <div class="profile-avatar me-3" style="width: 40px; height: 40px; font-size: 1.2rem;">
                  <%= user.initials %>
                </div>
                <div class="flex-grow-1">
                  <%= link_to user_path(user), class: "text-decoration-none" do %>
                    <div class="fw-bold">
                      <%= user.display_name %>
                    </div>
                  <% end %>
                  <small class="text-muted">
                    <%= pluralize(user.messages.where(room: @room).count, 'Nachricht') %>
                  </small>
                </div>
              </div>
            <% end %>
          <% else %>
            <div class="text-center text-muted py-3">
              <i class="bi bi-person-plus fs-4 mb-2 d-block"></i>
              <small>Noch keine aktiven Teilnehmer</small>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Room Info -->
      <div class="card">
        <div class="card-header">
          <h6 class="mb-0">
            <i class="bi bi-info-circle me-2"></i>
            Raum-Informationen
          </h6>
        </div>
        <div class="card-body">
          <div class="row text-center">
            <div class="col-6 border-end">
              <div class="bg-primary bg-opacity-10 rounded p-2 mb-2">
                <i class="bi bi-chat-text text-primary fs-5"></i>
              </div>
              <h6 class="mb-0"><%= @room.messages.count %></h6>
              <small class="text-muted">Nachrichten</small>
            </div>
            <div class="col-6">
              <div class="bg-success bg-opacity-10 rounded p-2 mb-2">
                <i class="bi bi-people text-success fs-5"></i>
              </div>
              <h6 class="mb-0"><%= active_users.count %></h6>
              <small class="text-muted">Teilnehmer</small>
            </div>
          </div>

          <hr>

          <div class="text-center">
            <small class="text-muted">
              <i class="bi bi-calendar3 me-1"></i>
              Erstellt am <%= @room.created_at.strftime("%d.%m.%Y") %>
            </small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="module">
  import { createConsumer } from "@rails/actioncable";

  document.addEventListener('DOMContentLoaded', function() {
    const roomId = <%= @room.id %>;
    let consumer, subscription;
    let replyToId = null;

    console.log('üîß Initializing WebSocket for room:', roomId);

    // Initialize WebSocket connection
    function initializeWebSocket() {
      try {
        consumer = createConsumer();

        subscription = consumer.subscriptions.create(
          { channel: "ChatChannel", room_id: roomId },
          {
            connected: function() {
              console.log("‚úÖ Connected to ChatChannel for room " + roomId);
              updateConnectionStatus(true);
            },

            disconnected: function() {
              console.log("‚ùå Disconnected from ChatChannel");
              updateConnectionStatus(false);
            },

            received: function(data) {
              console.log("üì® Received message:", data);
              addMessageToChat(data);
            }
          }
        );
      } catch (error) {
        console.error("‚ùå WebSocket initialization failed:", error);
        updateConnectionStatus(false);
      }
    }

    // Update connection status indicator
    function updateConnectionStatus(connected) {
      const indicator = document.getElementById('connection-status');
      if (indicator) {
        if (connected) {
          indicator.className = 'badge bg-success ms-2';
          indicator.title = 'WebSocket verbunden';
          indicator.textContent = '‚óè';
        } else {
          indicator.className = 'badge bg-warning ms-2';
          indicator.title = 'WebSocket getrennt';
          indicator.textContent = '‚óè';
        }
      }
    }

    // Add new message to chat
    function addMessageToChat(data) {
      const container = document.getElementById('messages-container');
      const noMessages = document.getElementById('no-messages');

      if (noMessages) {
        noMessages.style.display = 'none';
      }

      if (container) {
        container.insertAdjacentHTML('beforeend', data.message);

        // Attach event listeners to new reply buttons
        attachReplyEventListeners();

        // Auto-scroll to bottom
        setTimeout(function() {
          container.scrollTop = container.scrollHeight;
        }, 50);
      }
    }

    // Show reply preview
    function showReplyPreview(messageId, userName, content) {
      replyToId = messageId;
      const replyPreview = document.getElementById('reply-preview');
      const replyUserName = document.getElementById('reply-user-name');
      const replyContentPreview = document.getElementById('reply-content-preview');
      const replyToIdField = document.getElementById('reply-to-id');
      const messageInput = document.getElementById('message-input');

      if (replyPreview && replyUserName && replyContentPreview && replyToIdField) {
        replyUserName.textContent = userName;
        replyContentPreview.textContent = content.length > 100 ? content.substring(0, 100) + '...' : content;
        replyToIdField.value = messageId;
        replyPreview.style.display = 'block';

        // Focus message input
        if (messageInput) {
          messageInput.focus();
        }
      }
    }

    // Hide reply preview
    function hideReplyPreview() {
      replyToId = null;
      const replyPreview = document.getElementById('reply-preview');
      const replyToIdField = document.getElementById('reply-to-id');

      if (replyPreview) {
        replyPreview.style.display = 'none';
      }
      if (replyToIdField) {
        replyToIdField.value = '';
      }
    }

    // Attach event listeners to reply buttons
    function attachReplyEventListeners() {
      const replyButtons = document.querySelectorAll('.reply-btn');
      replyButtons.forEach(button => {
        if (!button.hasAttribute('data-listener-attached')) {
          button.addEventListener('click', function() {
            const messageId = this.getAttribute('data-message-id');
            const userName = this.getAttribute('data-user-name');
            const content = this.getAttribute('data-content');
            showReplyPreview(messageId, userName, content);
          });
          button.setAttribute('data-listener-attached', 'true');
        }
      });
    }

    // Cancel reply
    const cancelReplyBtn = document.getElementById('cancel-reply');
    if (cancelReplyBtn) {
      cancelReplyBtn.addEventListener('click', hideReplyPreview);
    }

    // Override form submission to use WebSocket
    const messageForm = document.getElementById('message-form');
    if (messageForm) {
      messageForm.addEventListener('submit', function(e) {
        e.preventDefault();

        const messageInput = document.getElementById('message-input');
        const content = messageInput.value.trim();

        if (!content) {
          alert('Bitte gib eine Nachricht ein.');
          return;
        }

        if (subscription && typeof subscription.perform === 'function') {
          // Prepare message data
          const messageData = { content: content };
          if (replyToId) {
            messageData.reply_to_id = replyToId;
          }

          // Send via WebSocket
          console.log('üöÄ Sending via WebSocket:', messageData);
          subscription.perform('send_message', messageData);
          messageInput.value = '';

          // Hide reply preview after sending
          hideReplyPreview();
        } else {
          // Fallback: submit form normally
          console.log('‚ö†Ô∏è No WebSocket connection, submitting form normally');
          e.target.submit();
        }
      });
    }

    // Handle Enter key
    const messageInput = document.getElementById('message-input');
    if (messageInput) {
      messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          messageForm.dispatchEvent(new Event('submit'));
        }
      });
    }

    // Auto-scroll to bottom on page load
    const container = document.getElementById('messages-container');
    if (container) {
      container.scrollTop = container.scrollHeight;
    }

    // Attach event listeners to existing reply buttons
    attachReplyEventListeners();

    // Initialize WebSocket
    initializeWebSocket();
  });
</script>
